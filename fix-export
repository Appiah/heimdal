#! /bin/sh
set -x

echo "fixing distribution in $1..."

cd $1

ver=`sed -n 's/AM_INIT_AUTOMAKE(.*,\(.*\))/\1/p' configure.in`
M="*   This is version $ver.   *"
echo "$M" | sed -e 's/./*/g'
echo "$M"
echo "$M" | sed -e 's/./*/g'

ed -s configure.in << END
/test -z/s,^,#,
w
q
END
aclocal -I cf
autoconf
autoheader
automake
(cd doc; makeinfo heimdal.texi)

make_proto () {
	   (top=`pwd`
	   cd $1
	   b=`basename $1`
	   perl $top/cf/make-proto.pl -o $2 -p $3 `perl -e '
		do { 
			$_ = <>; 
		} until(/'$b'_.*SOURCES/); 
		while(/\\\\\s*$/s){ 
			$_ = $_ . <>;
		} 
		s/\n//g; 
		s/\\\\//g; 
		s/.*=//; 
		s/\s+/ /g; 
		print;' Makefile.in`)
}

make_proto lib/krb5 krb5-protos.h krb5-private.h
make_proto lib/hdb hdb-protos.h hdb-private.h
make_proto appl/login login_protos.h /dev/null

rm fix-export make-release make-release.el
find . -name .cvsignore -print | xargs rm
